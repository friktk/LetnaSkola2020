<!doctype html><html lang=sk class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Výučbový systém BT-car3"><link href=https://friktk.github.io/LetnaSkola2020/pr6/ rel=canonical><meta name=author content="Martin Húdik"><link rel="shortcut icon" href=../images/icon.png><meta name=generator content="mkdocs-1.1, mkdocs-material-5.1.5"><title>Prerušovací podsystém - BT-car3</title><link rel=stylesheet href=../assets/stylesheets/main.df84b5fe.min.css><link rel=stylesheet href=../assets/stylesheets/palette.8435c73a.min.css><meta name=theme-color content=#3f51b5><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../stylesheets/extra.css><link rel=stylesheet href=../stylesheets/w3.css><link rel="preconnect dns-prefetch" href=https://www.google-analytics.com><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-165560005-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#uloha-vyuzitie-isr-v-triede-tlacidlo class=md-skip> Preskočiť na obsah </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label> <a href=https://friktk.github.io/LetnaSkola2020/ title=BT-car3 class="md-header-nav__button md-logo" aria-label=BT-car3> <img src=../images/logo.svg alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> BT-car3 </span> <span class="md-header-nav__topic md-ellipsis"> Prerušovací podsystém </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Hľadať placeholder=Hľadať autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/friktk/LetnaSkola2020.git title="Zobraziť repozitár" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> LetnaSkola 2020 </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class="md-tabs md-tabs--active" aria-label data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class="md-tabs__link md-tabs__link--active"> BT-car3 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://friktk.github.io/LetnaSkola2020/ title=BT-car3 class="md-nav__button md-logo" aria-label=BT-car3> <img src=../images/logo.svg alt=logo> </a> BT-car3 </label> <div class=md-nav__source> <a href=https://github.com/friktk/LetnaSkola2020.git title="Zobraziť repozitár" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> LetnaSkola 2020 </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1 checked> <label class=md-nav__link for=nav-1> BT-car3 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=BT-car3 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> BT-car3 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. title=Úvod class=md-nav__link> Úvod </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2 type=checkbox id=nav-1-2 checked> <label class=md-nav__link for=nav-1-2> Príklady <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Príklady data-md-level=2> <label class=md-nav__title for=nav-1-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Príklady </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../pr1/ title="Príklad 1 „RGB_LED“" class=md-nav__link> Príklad 1 „RGB_LED“ </a> </li> <li class=md-nav__item> <a href=../pr2/ title="Príklad 2 „RGB_AKU“" class=md-nav__link> Príklad 2 „RGB_AKU“ </a> </li> <li class=md-nav__item> <a href=../pr3/ title="Príklad 3 „TLAČIDLO“" class=md-nav__link> Príklad 3 „TLAČIDLO“ </a> </li> <li class=md-nav__item> <a href=../pr4/ title="Príklad 4 „UART“" class=md-nav__link> Príklad 4 „UART“ </a> </li> <li class=md-nav__item> <a href=../pr5/ title="Príklad 5 „Fotoodpor“" class=md-nav__link> Príklad 5 „Fotoodpor“ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Prerušovací podsystém <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg> </span> </label> <a href=./ title="Prerušovací podsystém" class="md-nav__link md-nav__link--active"> Prerušovací podsystém </a> <nav class="md-nav md-nav--secondary" aria-label=Obsah> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Obsah </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#uloha-vyuzitie-isr-v-triede-tlacidlo class=md-nav__link> Úloha využitie ISR v triede "TLACIDLO" </a> </li> <li class=md-nav__item> <a href=#implementacia-triedy-tlacidlo class=md-nav__link> Implementácia triedy TLACIDLO </a> </li> <li class=md-nav__item> <a href=#prerusenie-od-casovaca-t1-projekt-avr4 class=md-nav__link> Prerušenie od časovača T1- projekt AVR4 </a> <nav class=md-nav aria-label="Prerušenie od časovača T1- projekt AVR4"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#register-tccr1a class=md-nav__link> Register TCCR1A </a> </li> <li class=md-nav__item> <a href=#register-tccr1b class=md-nav__link> Register TCCR1B </a> </li> <li class=md-nav__item> <a href=#register-timsk1 class=md-nav__link> Register TIMSK1 </a> </li> <li class=md-nav__item> <a href=#register-tccr1c class=md-nav__link> Register TCCR1C </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#priklad-pouzitia class=md-nav__link> Príklad použitia: </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../pwm/ title=PWM class=md-nav__link> PWM </a> </li> <li class=md-nav__item> <a href=https://github.com/friktk/LetnaSkola2020/archive/ulohy.zip title=Download class=md-nav__link> Download </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <label class=md-nav__link for=nav-1-3> Cvičenia <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Cvičenia data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Cvičenia </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=https://github.com/friktk/LetnaSkola2020/archive/triedy_cvicenie.zip title=Knižnica class=md-nav__link> Knižnica </a> </li> <li class=md-nav__item> <a href=https://github.com/friktk/LetnaSkola2020/tree/priklady/schema title=Schémy class=md-nav__link> Schémy </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../link/ title="Odkazy a návody" class=md-nav__link> Odkazy a návody </a> </li> <li class=md-nav__item> <a href=../cheat_sheet/ title="Cheat Sheet jazyka C" class=md-nav__link> Cheat Sheet jazyka C </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=Obsah> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Obsah </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#uloha-vyuzitie-isr-v-triede-tlacidlo class=md-nav__link> Úloha využitie ISR v triede "TLACIDLO" </a> </li> <li class=md-nav__item> <a href=#implementacia-triedy-tlacidlo class=md-nav__link> Implementácia triedy TLACIDLO </a> </li> <li class=md-nav__item> <a href=#prerusenie-od-casovaca-t1-projekt-avr4 class=md-nav__link> Prerušenie od časovača T1- projekt AVR4 </a> <nav class=md-nav aria-label="Prerušenie od časovača T1- projekt AVR4"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#register-tccr1a class=md-nav__link> Register TCCR1A </a> </li> <li class=md-nav__item> <a href=#register-tccr1b class=md-nav__link> Register TCCR1B </a> </li> <li class=md-nav__item> <a href=#register-timsk1 class=md-nav__link> Register TIMSK1 </a> </li> <li class=md-nav__item> <a href=#register-tccr1c class=md-nav__link> Register TCCR1C </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#priklad-pouzitia class=md-nav__link> Príklad použitia: </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Prerušovací podsystém</h1> <p>Asynchrónne vyskytujúce sa udalosti môžeme v prípade ATmeg328 obsluhovať dvoma spôsobmi. Prvý z nich vyžaduje programovo sa neustále dopytovať či definovaná udalosť (napríklad prijatie nového znaku do registra UDR0) už nastala. V prípade, že udalosť nastala, je potrebné túto udalosť obslúžiť (napr. presunúť znak z registra UDR0 do pamäte). V tomto prípade hovoríme o programovom styku procesora s perifériou. </p> <div class="admonition example"> <p class=admonition-title>Príklad</p> <div class=highlight><pre><span></span><code><span class=kt>int</span> <span class=n>PrimUart</span><span class=o>::</span><span class=n>USART_receive_byte</span><span class=p>(</span><span class=kt>FILE</span><span class=o>*</span><span class=n>stream</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>uint8_t</span> <span class=n>u8data</span><span class=p>;</span>
    <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>UCSR0A</span><span class=o>&amp;</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>RXC0</span><span class=p>))){};</span>    <span class=c1>//caka na splnenie podmienky</span>
    <span class=n>u8data</span><span class=o>=</span><span class=n>UDR0</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>u8data</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div> </div> <p>Na obsluhu takýchto náhodne vznikajúcich udalostí je vhodné využiť prerušovací systém. V tomto prípade nemusí procesor testovať a čakať, či už daná udalosť nastala, ale môže sa venovať iným činnostiam. Pri výskyte definovanej udalosti (prijatie znaku) sa automaticky preruší doterajšia činnosť procesora a začne sa vykonávať obsluha vzniknutej udalosti. Po obslúžení prerušenia sa procesor vráti do toho kroku, v ktorom bola jeho pôvodná činnosť prerušená a pokračuje v nej.</p> <p>Ako to ceĺé funguje? Nech sa procesor venuje realizácii programu (spracováva jednotlivé inštrukcie programu). V istom okamžiku je generovaná žiadosť o prerušenie. Žiadosť môže byť generovaná len jedným z prípustných zdrojov. V našom MCU len zo zdrojov uvedených v tabuľke nižšie. Riadiaca jednotka prerušenia identifikuje zdroj, ktorý generoval žiadosť, vyhodnotí jeho prioritu a v prípade, že žiadosť je akceptovaná t.j. prerušenie je povolené a neprebieha obsluha prerušenia s vyššou prioritou, tak sa naplní programový čítač (PC) adresou (Program Address), ktorá zodpovedá vektoru prerušenia (2 až 26). Poznamenajme, že čím je číslo prerušenia (to zodpovedá zdroju, ktorý žiadosť o prerušenie generoval, viď tabuľka nižšie) nižšie, tým je priorita prerušenia vyššia. Napr. v prípade generovania žiadosti od obvodu USART pri príjme znaku „USART RX Complete“ sa generuje žiadosť odpovedajúca vektoru 19 a PC sa naplní hodnotou 0x0024 (nech tabuľka vektorov začína na adr0x0002). Na tejto adrese je uložená prvá inštrukcia obsluhy prerušenia. Najčastejšie je to inštrukcia skoku na adresu konkrétnej obsluhy prerušenia. V tejto obsluhe sa vykonajú všetky potrebné úkony a po skončení obsluhy sa vykoná návrat z prerušenia do pôvodného programu. Pretože v prípade používania jazyka C/C++ sa o väčšinu uvedených činností stará kód, ktorý je generovaný prekladačom nebudeme sa zaoberať podrobným popisom. (O uchovávaní návratových adries v zásobníku a pod. sa ani nezmieňujeme).</p> <p><img alt=img src=../images/int_vectors.png></p> <p>Počiatočnú adresu tabuľky vektorov prerušenia je možné modifikovať pomocou vhodného nastavenia bitov BOOTRST a IVSEL v registri „Extended Fuse Byte“ a MCUCR.</p> <p><img alt=img src=../images/reset_addr.jpg></p> <p><em>Zdroj: Katalógový list ATmega328</em></p> <p>Prerušenia na vývodoch PCINT23 . . .0 sú rozdelené do troch skupín: </p> <ul> <li> <p>PCINT0 prináleží k PCINT[7:0]</p> </li> <li> <p>PCINT1 prináleží k PCINT[14:8]</p> </li> <li> <p>PCINT2 prináleží k PCINT[23:16]</p> </li> </ul> <p>Prerušenie bude generované, ak:</p> <ol> <li>je prerušenie povolené globálne, nastavením bitu I v registri stavu SREG, </li> <li>je povolené prerušenie príslušnej skupiny v registri PCICR,</li> <li>je povolené lokálne prerušenie v registroch PCMSKx,</li> <li>a vyskytne sa ľubovoľná zmena stavu na príslušnom vývode MCU(H-&gt;L, alebo L-&gt;H)</li> </ol> <p>Maska prerušenia <strong>PCICR</strong>:</p> <table> <thead> <tr> <th>Bit</th> <th>7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>Označ.</td> <td>-</td> <td>-</td> <td>-</td> <td>-</td> <td>-</td> <td>PCIE2</td> <td>PCIE1</td> <td>PCIE0</td> </tr> <tr> <td>Prístup</td> <td>R</td> <td>R</td> <td>R</td> <td>R</td> <td>R</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td>P.hodn.</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> </tr> </tbody> </table> <p>Príznak prerušenia <strong>PCIFR</strong>:</p> <table> <thead> <tr> <th>bit</th> <th>7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>Označ.</td> <td>-</td> <td>-</td> <td>-</td> <td>-</td> <td>-</td> <td>PCIF2</td> <td>PCIF1</td> <td>PCIF0</td> </tr> <tr> <td>Prístup</td> <td>R</td> <td>R</td> <td>R</td> <td>R</td> <td>R</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td>P.hodn.</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> </tr> </tbody> </table> <p>Príznak je nulovaný automaticky pri skončení zodpovedajúcej obsluhy prerušenia. Alternatívne zápisom logickej jednotky.</p> <p>Lokálna maska prerušenia <strong>PCMSK0</strong>:</p> <table> <thead> <tr> <th>bit</th> <th>7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>Oznac.</td> <td>PCINT7</td> <td>PCINT6</td> <td>PCINT5</td> <td>PCINT4</td> <td>PCINT3</td> <td>PCINT2</td> <td>PCINT1</td> <td>PCINT0</td> </tr> <tr> <td>Pristup</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td>P.hodn.</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> </tr> </tbody> </table> <p>Lokálna maska prerušenia <strong>PCMSK1</strong>:</p> <table> <thead> <tr> <th>bit</th> <th>7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>Oznac.</td> <td>-</td> <td>PCINT14</td> <td>PCINT13</td> <td>PCINT12</td> <td>PCINT11</td> <td>PCINT10</td> <td>PCINT9</td> <td>PCINT8</td> </tr> <tr> <td>Pristup</td> <td>R</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td>P.hodn.</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> </tr> </tbody> </table> <p>Lokálna maska prerušenia <strong>PCMSK2</strong>:</p> <table> <thead> <tr> <th>bit</th> <th>7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>Oznac.</td> <td>PCINT23</td> <td>PCINT22</td> <td>PCINT21</td> <td>PCINT20</td> <td>PCINT19</td> <td>PCINT18</td> <td>PCINT17</td> <td>PCINT16</td> </tr> <tr> <td>Pristup</td> <td>R</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td>P.hodn.</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> </tr> </tbody> </table> <h3 id=uloha-vyuzitie-isr-v-triede-tlacidlo>Úloha využitie ISR v triede "TLACIDLO"<a class=headerlink href=#uloha-vyuzitie-isr-v-triede-tlacidlo title="Permanent link">&para;</a></h3> <p>Našou úlohou je využiť prerušovací systém na sledovanie stavu tlačidla USR. Pripomeňme, že tlačidlo je pripojené na vývod PB0 podľa obrázku. Potom je možné pri stlačení tlačidla generovať žiadosť o prerušenie, ak je povolené. </p> <p><img alt=image-20200713163532906 src=../images/uloha_int.png#75size></p> <p>lačidlo USR je pripojené na PB0 t.j. PCINT0, preto je potrebné nastaviť na hodnotu log.1 PCINT2 v registri PCMSK0,</p> <p>PCIE0 v registri PCICR – povolenie prerušenia od skupiny PCINT0. Nakoniec povolíme celý prerušovací systém tak, že v stavovom registri, SREG nastavíme bit I na logickú 1. Toto je možné realizovať použitím makra <code>sei()</code> - <strong>globálne povolenie prerušení</strong>. Opakom makra <code>sei()</code> je makro <code>cli()</code> - <strong>globálny zákaz prerušení</strong>.</p> <h3 id=implementacia-triedy-tlacidlo>Implementácia triedy TLACIDLO<a class=headerlink href=#implementacia-triedy-tlacidlo title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1>Hlavičkový súbor TLACIDLO.h</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=cp>#ifndef __TLACIDLO_H__</span>
<span class=cp>#define __TLACIDLO_H__</span>
<span class=cp>#include</span> <span class=cpf>&quot;BOARD_AVR.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;RGB.h&quot;</span><span class=cp></span>

<span class=c1>//extern bool Tl_stav;</span>

<span class=k>class</span> <span class=nc>TLAC</span> <span class=o>:</span> <span class=n>RGB</span>
<span class=p>{</span>
<span class=c1>//variables</span>

<span class=k>public</span><span class=o>:</span>
    <span class=n>TLAC</span><span class=p>();</span>
    <span class=o>~</span><span class=n>TLAC</span><span class=p>();</span>
    <span class=kt>bool</span> <span class=nf>Get_Tlacidlo</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>

    <span class=k>static</span> <span class=kt>void</span> <span class=nf>obsluha_interruptTL</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
    <span class=kt>void</span> <span class=nf>Tlac_init</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>

<span class=k>protected</span><span class=o>:</span>
<span class=k>private</span><span class=o>:</span>
<span class=p>};</span> <span class=c1>//TLACIDLO</span>

<span class=cp>#endif </span><span class=c1>//__TLACIDLO_H__</span>
</code></pre></div> </div> <input id=__tabbed_1_2 name=__tabbed_1 type=radio><label for=__tabbed_1_2>Definičný súbor TLACIDLO.cpp</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=cp>#include</span> <span class=cpf>&quot;TLACIDLO.h&quot;</span><span class=cp></span>

<span class=c1>// default constructor</span>
<span class=n>TLAC</span><span class=o>::</span><span class=n>TLAC</span><span class=p>()</span>
<span class=p>{</span>
    <span class=c1>//  tlacidlo_pointer = this;</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PORTB</span><span class=p>,</span> <span class=n>TL</span><span class=p>);</span> <span class=c1>//pull-up</span>
    <span class=n>cbi</span><span class=p>(</span><span class=n>DDRB</span><span class=p>,</span> <span class=n>TL</span><span class=p>);</span>  <span class=c1>// vstup</span>
    <span class=c1>//  Tl_stav = false;</span>
<span class=p>}</span> <span class=c1>//TLACIDLO</span>

<span class=c1>// default destructor</span>
<span class=n>TLAC</span><span class=o>::~</span><span class=n>TLAC</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>cbi</span><span class=p>(</span><span class=n>PCMSK0</span><span class=p>,</span> <span class=n>PCINT0</span><span class=p>);</span> <span class=c1>// zakaz prerusenia od PB0</span>
<span class=p>}</span> <span class=c1>//~TLACIDLO</span>

<span class=kt>bool</span> <span class=n>TLAC</span><span class=o>::</span><span class=n>Get_Tlacidlo</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>PINB</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>TL</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
        <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
    <span class=k>else</span>
        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>TLAC</span><span class=o>::</span><span class=n>Tlac_init</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PCICR</span><span class=p>,</span> <span class=n>PCIE0</span><span class=p>);</span>   <span class=c1>//povolenie prerusenia 0-tej skupiny</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PCMSK0</span><span class=p>,</span> <span class=n>PCINT0</span><span class=p>);</span> <span class=c1>// povolenie prerusenia od PB0 pri kazdej zmene</span>
<span class=p>}</span>

<span class=n>ISR</span><span class=p>(</span><span class=n>PCINT0_vect</span><span class=p>)</span>
<span class=p>{</span>
     <span class=n>tbi</span><span class=p>(</span><span class=n>PORTD</span><span class=p>,</span> <span class=n>LED_RED</span><span class=p>);</span>
    <span class=n>_delay_ms</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PCIFR</span><span class=p>,</span> <span class=n>PCIF0</span><span class=p>);</span> <span class=c1>// vynulovanie priznaku prerusenia</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_1_3 name=__tabbed_1 type=radio><label for=__tabbed_1_3>Alternatívna forma obsluhy prerušenia: TLACIDLO.cpp</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=cp>#include</span> <span class=cpf>&quot;TLACIDLO.h&quot;</span><span class=cp></span>

<span class=c1>// default constructor</span>
<span class=n>TLAC</span><span class=o>::</span><span class=n>TLAC</span><span class=p>()</span>
<span class=p>{</span>
    <span class=c1>//  tlacidlo_pointer = this;</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PORTB</span><span class=p>,</span> <span class=n>TL</span><span class=p>);</span> <span class=c1>//pull-up</span>
    <span class=n>cbi</span><span class=p>(</span><span class=n>DDRB</span><span class=p>,</span> <span class=n>TL</span><span class=p>);</span>  <span class=c1>// vstup</span>
    <span class=c1>//  Tl_stav = false;</span>
<span class=p>}</span> <span class=c1>//TLACIDLO</span>

<span class=c1>// default destructor</span>
<span class=n>TLAC</span><span class=o>::~</span><span class=n>TLAC</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>cbi</span><span class=p>(</span><span class=n>PCMSK0</span><span class=p>,</span> <span class=n>PCINT0</span><span class=p>);</span> <span class=c1>// zakaz prerusenia od PB0</span>
<span class=p>}</span> <span class=c1>//~TLACIDLO</span>

<span class=kt>bool</span> <span class=n>TLAC</span><span class=o>::</span><span class=n>Get_Tlacidlo</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>PINB</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>TL</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
        <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
    <span class=k>else</span>
        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>TLAC</span><span class=o>::</span><span class=n>Tlac_init</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PCICR</span><span class=p>,</span> <span class=n>PCIE0</span><span class=p>);</span>   <span class=c1>//povolenie prerusenia 0-tej skupiny</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PCMSK0</span><span class=p>,</span> <span class=n>PCINT0</span><span class=p>);</span> <span class=c1>// povolenie prerusenia od PB0 pri kazdej zmene</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>TLAC</span><span class=o>::</span><span class=n>obsluha_interruptTL</span><span class=p>(){</span>
    <span class=n>tbi</span><span class=p>(</span><span class=n>PORTD</span><span class=p>,</span> <span class=n>LED_RED</span><span class=p>);</span>
    <span class=n>_delay_ms</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PCIFR</span><span class=p>,</span> <span class=n>PCIF0</span><span class=p>);</span> <span class=c1>// vynulovanie priznaku prerusenia</span>
<span class=p>}</span>

<span class=n>ISR</span><span class=p>(</span><span class=n>PCINT0_vect</span><span class=p>)</span>
<span class=p>{</span>
   <span class=n>TLAC</span><span class=o>::</span><span class=n>obsluha_interruptTL</span><span class=p>();</span>
 <span class=p>}</span>
</code></pre></div> </div> </div> <p>Príklad použitia:</p> <div class=tabbed-set data-tabs=2:1><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><label for=__tabbed_2_1>main.cpp</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=cp>#include</span> <span class=cpf>&quot;BOARD_AVR.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;UART_BT.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;TLACIDLO.h&quot;</span><span class=cp></span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>UART_BT</span> <span class=n>uart</span><span class=p>;</span>

    <span class=n>uart</span><span class=p>.</span><span class=n>Uart_int</span><span class=p>();</span>   <span class=c1>// 115200 8N1</span>
    <span class=n>uart</span><span class=p>.</span><span class=n>Uart_send</span><span class=p>(</span><span class=s>&quot;AVR_BOARD</span><span class=se>\r</span><span class=s>&quot;</span><span class=p>);</span>

    <span class=n>TLAC</span> <span class=n>tlac</span><span class=p>;</span>
    <span class=n>tlac</span><span class=p>.</span><span class=n>Tlac_init</span><span class=p>();</span>
    <span class=n>sei</span><span class=p>();</span>

        <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> 
        <span class=p>{</span>

        <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>Uvedený príklad je veľmi jednoduchý, nie je to typická ukážka obsluhy prerušenia pri objektovom prístupe. Prerušovacia rutina ISR je statická. Poznamenávam, že čakanie 50 ms v prerušovacej rutine nie je vhodné riešenie. 50 ms sú blokované žiadosti o prerušenie s nižšou prioritou, čo môže mať vo väčšine aplikácií fatálne následky. </p> <h2 id=prerusenie-od-casovaca-t1-projekt-avr4>Prerušenie od časovača T1- projekt AVR4<a class=headerlink href=#prerusenie-od-casovaca-t1-projekt-avr4 title="Permanent link">&para;</a></h2> <p>Na doplnenie uvedieme ešte jeden príklad prerušenia od interného zdroja – časovača T1. Najskôr zopár slov o časovači/čítači T1.</p> <p><strong>Charakteristika:</strong></p> <ul> <li>16-bitový čítač/časovač, (16-bit PWM),</li> <li>dve nezávislé výstupné porovnávacie jednotky,</li> <li>výstupné porovnávacie registre,</li> <li>vstupná záchytná jednotka,</li> <li>vstup s potlačením šumu,</li> <li>nulovanie čítača pri zhode (Auto Reload),</li> <li>Bez zákmitová fázovo korektná PWM,</li> <li>PWM s premenlivou periódou,</li> <li>frekvenčný generátor,</li> <li>čítač externých udalostí,</li> <li>štyri nezávislé zdroje prerušenia (TOV1, OCF1A, OCF1B, and ICF1).</li> </ul> <p><img alt=image-20200713185746452 src=../images/image-citac.png></p> <p><strong>Čítač/časovač1</strong></p> <p>V tabuľke prerušení si všimnime, že modul časovača T1 môže generovať žiadosť o prerušenie pri nasledovných udalostiach.</p> <ul> <li>TIMER1_CAPT</li> <li>TIMER1_COMPA</li> <li>TIMER1_COMPB</li> <li>TIMER1_OVF </li> </ul> <p>Najskôr však popíšeme niektoré registre, ktoré súvisia s čítačom/časovačom 1. Ich význam bezprostredne súvisí s programovým riešením.</p> <h3 id=register-tccr1a>Register TCCR1A<a class=headerlink href=#register-tccr1a title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th><strong>Bit 7</strong></th> <th><strong>6</strong></th> <th><strong>5</strong></th> <th><strong>4</strong></th> <th><strong>3</strong></th> <th><strong>2</strong></th> <th><strong>1</strong></th> <th><strong>0</strong></th> </tr> </thead> <tbody> <tr> <td>COM1A1</td> <td>COM1A0</td> <td>COM1B1</td> <td>COM1B0</td> <td>-</td> <td>-</td> <td>WGM11</td> <td>WGM10</td> </tr> <tr> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td></td> <td></td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td></td> <td></td> <td>0</td> <td>0</td> </tr> </tbody> </table> <p>COM1A1, COM1A0 voľba režimu vývodu OC1A , COM1B1, COM1B0 voľba režimu vývodu OC1B. V režime časovač môže ostať pôvodné nastavenie. </p> <h3 id=register-tccr1b>Register TCCR1B<a class=headerlink href=#register-tccr1b title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Bit 7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>ICNC1</td> <td>ICES1</td> <td>-</td> <td>WGM13</td> <td>WGM12</td> <td>CS12</td> <td>CS11</td> <td>CS10</td> </tr> <tr> <td>R/W</td> <td>R/W</td> <td></td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td>0</td> <td>0</td> <td></td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> <td>0</td> </tr> </tbody> </table> <p>ICNC1 - potlačenie šumu, ICES1 voľba hrany, WGM12, WGM13 voľba režimu, CS12, CS11, CS10 voľba hodín. V režime časovač môže ostať pôvodné nastavenie. Modifikujeme len voľbu hodín.</p> <h3 id=register-timsk1>Register TIMSK1<a class=headerlink href=#register-timsk1 title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Bit 7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>-</td> <td>-</td> <td>ICIE</td> <td>-</td> <td>-</td> <td>OCIEB</td> <td>OCIEA</td> <td>TOIE</td> </tr> <tr> <td></td> <td></td> <td>R/W</td> <td></td> <td></td> <td>R/W</td> <td>R/W</td> <td>R/W</td> </tr> <tr> <td></td> <td></td> <td>0</td> <td></td> <td></td> <td>0</td> <td>0</td> <td>0</td> </tr> </tbody> </table> <p>Ak chceme lokálne povoliť prerušenie od jednotlivých zdrojov je potrebné príslušné bity nastaviť na hodnotu log.1.</p> <h3 id=register-tccr1c>Register TCCR1C<a class=headerlink href=#register-tccr1c title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Bit 7</th> <th>6</th> <th>5</th> <th>4</th> <th>3</th> <th>2</th> <th>1</th> <th>0</th> </tr> </thead> <tbody> <tr> <td>FOC1A</td> <td>FOC1B</td> <td>-</td> <td>-</td> <td>-</td> <td>-</td> <td>-</td> <td>-</td> </tr> <tr> <td>R/W</td> <td>R/W</td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr> <td>0</td> <td>0</td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> </tbody> </table> <p>FOC1A, FOC1B súvisia s riadením vývodov OC1A a OC1B. V režime časovač môže ostať pôvodné nastavenie.</p> <p>Ďalšie registre čítača/časovača1:</p> <ul> <li>TCNT1 (H, L) 16-bitový register (prístup cez dva 8-bitové) </li> <li>ICR1 (H, L) 16-bitový register</li> <li>OCR1A (H, L) 16-bitový porovnávací register A</li> <li>OCR1B (H, L) 16-bitový porovnávací register B</li> </ul> <h2 id=priklad-pouzitia>Príklad použitia:<a class=headerlink href=#priklad-pouzitia title="Permanent link">&para;</a></h2> <div class=tabbed-set data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><label for=__tabbed_3_1>PrerT1_OVF.h</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=cm>/* </span>
<span class=cm>* PrerT1_OVF.h</span>
<span class=cm>*</span>
<span class=cm>* Created: 6.7.2020 11:37:31</span>
<span class=cm>* Author: Juraj</span>
<span class=cm>*/</span>

<span class=cp>#ifndef __PRERT1_OVF_H__</span>
<span class=cp>#define __PRERT1_OVF_H__</span>

<span class=cp>#include</span> <span class=cpf>&quot;BOARD_AVR.h&quot;</span><span class=cp></span>

<span class=cp>#define STRINGIFY(name) #name</span>

<span class=cp>#define CLASS_IRQ(name, vektor)                   \</span>
<span class=cp>    static void name(void) asm(STRINGIFY(vektor)) \</span>
<span class=cp>        __attribute__((signal, __INTR_ATTRS))</span>

<span class=cp>#define TIMER1_TIMEOUT 64364; </span><span class=c1>//  T_T = 65534 - //cas[s]/[(1/FCPU)*delic_hodin];   16-bit \</span>
                              <span class=c1>//  100ms:    65536 - 0.1/(0.000000083*d1024) = 64364;</span>

<span class=cm>/***************************************************/</span>
<span class=cp>#define STRINGIFY(name) #name</span>

<span class=cp>#define CLASS_IRQ(name, vektor)                   \</span>
<span class=cp>    static void name(void) asm(STRINGIFY(vektor)) \</span>
<span class=cp>        __attribute__((signal, __INTR_ATTRS))</span>

<span class=k>class</span> <span class=nc>PrerT1_OVF</span>
<span class=p>{</span>
    <span class=c1>//variables</span>
<span class=k>public</span><span class=o>:</span>
<span class=k>protected</span><span class=o>:</span>
<span class=k>private</span><span class=o>:</span>
    <span class=k>volatile</span> <span class=k>static</span> <span class=kt>uint16_t</span> <span class=n>Timer1</span><span class=p>;</span> <span class=c1>//volatile</span>
                                     <span class=c1>//functions</span>
<span class=k>public</span><span class=o>:</span>
    <span class=n>PrerT1_OVF</span><span class=p>();</span>
    <span class=o>~</span><span class=n>PrerT1_OVF</span><span class=p>();</span>
    <span class=kt>uint16_t</span> <span class=nf>getTim1</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
    <span class=kt>void</span> <span class=nf>setTim1</span><span class=p>(</span><span class=kt>uint16_t</span><span class=p>);</span>
    <span class=k>static</span> <span class=kt>void</span> <span class=nf>OverflowInterrupt1</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>

<span class=k>private</span><span class=o>:</span>
    <span class=c1>// CLASS_IRQ(OverflowInterrupt1, TIMER1_OVF_vect);</span>

<span class=p>};</span> <span class=c1>//PrerT1_OVF</span>

<span class=cp>#endif </span><span class=c1>//__PRERT1_OVF_H__</span>
</code></pre></div> </div> <input id=__tabbed_3_2 name=__tabbed_3 type=radio><label for=__tabbed_3_2>PrerT1_OVF.cpp</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=cm>/* </span>
<span class=cm>* PrerT1_OVF.cpp</span>
<span class=cm>*</span>
<span class=cm>* Created: 6.7.2020 11:37:31</span>
<span class=cm>* Author: Juraj</span>
<span class=cm>*/</span>


<span class=cp>#include</span> <span class=cpf>&quot;PrerT1_OVF.h&quot;</span><span class=cp></span>

<span class=k>volatile</span> <span class=kt>uint16_t</span> <span class=n>PrerT1_OVF</span><span class=o>::</span><span class=n>Timer1</span><span class=p>;</span>

<span class=n>PrerT1_OVF</span><span class=o>::</span><span class=n>PrerT1_OVF</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>PRR</span> <span class=o>&amp;=~</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>PRTIM1</span><span class=p>);</span>         <span class=c1>// zapneme TIM0 napriek tomu, ze je def. zapnute</span>

    <span class=kt>uint8_t</span> <span class=n>sreg</span> <span class=o>=</span> <span class=n>SREG</span><span class=p>;</span>
    <span class=n>cli</span><span class=p>();</span>                      <span class=c1>// atomicka operacia</span>
    <span class=n>TCNT1</span> <span class=o>=</span> <span class=n>TIMER1_TIMEOUT</span><span class=p>;</span>
    <span class=n>SREG</span> <span class=o>=</span> <span class=n>sreg</span><span class=p>;</span>
    <span class=n>TCCR1B</span> <span class=o>|=</span> <span class=n>d1024</span><span class=p>;</span>            <span class=c1>// nastavenie preddelicky clkio</span>
    <span class=n>TIMSK1</span> <span class=o>|=</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>TOIE1</span><span class=p>);</span>       <span class=c1>// povolenie prerusenia</span>
    <span class=k>this</span><span class=o>-&gt;</span><span class=n>Timer1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>PrerT1_OVF</span><span class=o>::~</span><span class=n>PrerT1_OVF</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>TIMSK1</span> <span class=o>&amp;=~</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>TOIE1</span><span class=p>);</span>       <span class=c1>// zakazanie prerusenia</span>
    <span class=c1>//  PRR |=(1&lt;&lt;PRTIM1);      // vypneme TIM0 ak chceme setrit, ale pozor nepojde nic</span>
<span class=p>}</span>


<span class=cm>/**********************metody public*************************/</span>
<span class=kt>uint16_t</span> <span class=n>PrerT1_OVF</span><span class=o>::</span><span class=n>getTim1</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
    <span class=k>return</span> <span class=n>Timer1</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span>  <span class=n>PrerT1_OVF</span><span class=o>::</span><span class=n>setTim1</span><span class=p>(</span><span class=kt>uint16_t</span> <span class=n>hod</span><span class=p>){</span>
    <span class=n>Timer1</span> <span class=o>=</span> <span class=n>hod</span><span class=p>;</span>
<span class=p>}</span>


<span class=kt>void</span> <span class=n>PrerT1_OVF</span><span class=o>::</span><span class=n>OverflowInterrupt1</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>   <span class=c1>// staticka funkcia, nemozeme pouzit this</span>
<span class=p>{</span>
    <span class=c1>// atomicka operacia</span>
    <span class=n>cli</span><span class=p>();</span>      <span class=c1>// ak som sa ocitol tu, tak muselo byt glob. povolene prerusenie</span>
    <span class=n>TCNT1</span> <span class=o>=</span> <span class=n>TIMER1_TIMEOUT</span><span class=p>;</span>     <span class=c1>//restart</span>
    <span class=n>sei</span><span class=p>();</span>
    <span class=n>Timer1</span><span class=o>++</span><span class=p>;</span>

<span class=p>}</span>

 <span class=n>ISR</span><span class=p>(</span><span class=n>TIMER1_OVF_vect</span><span class=p>){</span>
    <span class=n>PrerT1_OVF</span><span class=o>::</span><span class=n>OverflowInterrupt1</span><span class=p>();</span>
 <span class=p>}</span>
</code></pre></div> </div> </div> <p>Uvedieme ešte výpis <code>main()</code>. V programe je využitá obsluha prerušenia od pretečenie časovača T1, PrerT1_OVF.</p> <div class=tabbed-set data-tabs=4:1><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><label for=__tabbed_4_1>main.cpp</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=cm>/*</span>
<span class=cm> * AVR4.cpp</span>
<span class=cm> *</span>
<span class=cm> * Created: 6.7.2020 11:22:27</span>
<span class=cm> * Author : Juraj</span>
<span class=cm> */</span>

<span class=cp>#include</span> <span class=cpf>&quot;BOARD_AVR.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;PrerT1_OVF.h&quot;</span><span class=cp></span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>DDRD</span><span class=p>,</span> <span class=n>LED_RED</span><span class=p>);</span> <span class=c1>// cervena svieti pri stlaceni</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>DDRD</span><span class=p>,</span> <span class=n>LED_BLUE</span><span class=p>);</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>DDRD</span><span class=p>,</span> <span class=n>LED_GREEN</span><span class=p>);</span>
    <span class=n>_delay_ms</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>

    <span class=n>sbi</span><span class=p>(</span><span class=n>PORTD</span><span class=p>,</span> <span class=n>LED_BLUE</span><span class=p>);</span> <span class=c1>// vsetko zhasne</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PORTD</span><span class=p>,</span> <span class=n>LED_GREEN</span><span class=p>);</span>
    <span class=n>sbi</span><span class=p>(</span><span class=n>PORTD</span><span class=p>,</span> <span class=n>LED_RED</span><span class=p>);</span>

    <span class=n>PrerT1_OVF</span> <span class=n>timer11</span><span class=p>;</span> <span class=c1>// objekt timer11 nastavenie  konstruktore</span>

    <span class=n>sei</span><span class=p>();</span> <span class=c1>// globalne povolim prerusenie</span>

    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>timer11</span><span class=p>.</span><span class=n>getTim1</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>30</span><span class=p>)</span>
        <span class=p>{</span> <span class=c1>// 30 * 100ms = 3s</span>
            <span class=n>timer11</span><span class=p>.</span><span class=n>setTim1</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>

            <span class=n>cbi</span><span class=p>(</span><span class=n>PORTD</span><span class=p>,</span> <span class=n>LED_GREEN</span><span class=p>);</span> <span class=c1>// zasvieti</span>
            <span class=n>_delay_ms</span><span class=p>(</span><span class=mi>50</span><span class=p>);</span>
            <span class=n>sbi</span><span class=p>(</span><span class=n>PORTD</span><span class=p>,</span> <span class=n>LED_GREEN</span><span class=p>);</span> <span class=c1>// zhasne</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>Iste ste si všimli, že na ovládanie <code>RGB_LED</code> teraz nepoužívame už vytvorenú triedu. Nie je to zámer, je to len naša lenivosť. Svietenie/zhasnutie RGB je natoľko jednoduché, že sa nám nechce prilinkovať súbory RGB.h a RGB.cpp. Neskôr to upravíme. </p> <p>V úvode vytvoríme objekt triedy „ PrerT1_OVF. Vytvorený objekt sa volá „Timer11. Po vytvorení je možné využívať verejne prístupné metódy. V triede „PrerT1_OVF()“ sa nastavenie lokálnych parametrov realizuje v konštruktore triedy. Po spustení by mal program každé 3 sekundy bliknúť (50 ms) zelenou diódou.</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label> <a href=../pr5/ title="Príklad 5 „Fotoodpor“" class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Späť </span> Príklad 5 „Fotoodpor“ </div> </div> </a> <a href=../pwm/ title=PWM class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Ďalej </span> PWM </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 Juraj Miček </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/friktk target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../assets/javascripts/vendor.83fe6e3c.min.js></script> <script src=../assets/javascripts/bundle.7e1cb91c.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Kop\u00edrova\u0165 do schr\u00e1nky", "clipboard.copied": "Skop\u00edrovan\u00e9 do schr\u00e1nky", "search.config.lang": "", "search.config.pipeline": "", "search.config.separator": "", "search.result.placeholder": "Pre vyh\u013ead\u00e1vanie za\u010dni p\u00edsa\u0165", "search.result.none": "\u017diadne vyhovuj\u00face dokumenty", "search.result.one": "Vyhovuj\u00faci dokument: 1", "search.result.other": "Vyhovuj\u00face dokumenty: #"}</script> <script>
        app = initialize({
          base: "..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>